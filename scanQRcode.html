<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport"
			content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/AFNUtils.js"></script>
		<style type="text/css">
			html,
			body,
			div {
				height: 100%;
				width: 100%;
			}

			.mui-content {
				width: 100%;
				height: 100%;
				display: flex;
				background-color: #000000;
			}

			.mui-title {
				color: #474545;
			}

			#bcid {
				width: 100%;
				height: calc(100% - 44px);
				/* position: absolute; */
				background: #000000;
			}

			.mui-bar {
				background-color: transparent;
			}

			a {
				color: #474545;
			}

			#turnTheLight {
				color: #474545;
			}

			.bottomV {
				display: flex;
			}

			.fbt {
				color: #4C4845;
				flex: 1;
				background-color: #F5A900;
				font-weight: bold;
				line-height: 44px;
				float: left;
				text-align: center;
			}

			.fbt1 {
				width: 3px;
				float: left;
				background-color: #000000;
				height: 44px;
			}
		</style>
		<script src="../../js/language/jquery.min.js"></script>
		<script language="javaScript">
			var lan = navigator.language || navigator.browserLanguage;
			var temp = lan.substring(0, 2);
			if (temp == 'zh') {
				document.write("<script src='../../js/language/zh-cn.js'><\/script>");
			} else {
				document.write("<script src='../../js/language/en-us.js'><\/script>");
			}
		</script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				var scan = null; //扫描对象
				//获取检测权限的状态  
				var checkResult = plus.navigator.checkPermission('CAMERA');
				//判断检查权限的结果  
				switch (checkResult) {
					case 'authorized':
						//正常的  
						break;
					case 'denied':
						//表示程序已被用户拒绝使用此权限，如果是拒绝的就再次提示用户打开确认提示框  
						openCamera();
						return;
						break;
					case 'undetermined':
						// 表示程序未确定是否可使用此权限，此时调用对应的API时系统会弹出提示框让用户确认  
						// return;
						break;
					case 'unknown':
						alert(AFNUtils_langType('scan_rules_unknown'));
						return;
						break;
					default:
						alert(AFNUtils_langType('scan_rules_default'));
						return;
						break;
				}
				// 去设置中打开相机权限
				function openCamera() {
					var msg = AFNUtils_langType('scan_rules_desc');
					mui.alert(msg, AFNUtils_langType('scan_rules_title'), AFNUtils_langType('scan_rules_btn'),
						function() {
							if (mui.os.ios) {
								plus.runtime.openURL("app-settings:CAMERA");
							} else { //安卓部分暂未测试
								var main = plus.android.runtimeMainActivity();
								var Intent = plus.android.importClass("android.content.Intent");
								var Build = plus.android.importClass("android.os.Build");
								var Uri = plus.android.importClass("android.net.Uri");
								var intent = new Intent();
								intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
								if (Build.VERSION.SDK_INT >= 9) { //系统8.0以上的  
									intent.setAction("android.settings.APPLICATION_DETAILS_SETTINGS");
									intent.setData(Uri.fromParts("package", main.getPackageName(), null));
								} else if (Build.VERSION.SDK_INT <= 8) { //系统8.0以下的  
									intent.setAction(Intent.ACTION_VIEW);
									intent.setClassName("com.android.settings",
										"com.android.setting.InstalledAppDetails");
									intent.putExtra("com.android.settings.ApplicationPkgName", main
										.getPackageName());
								}
								main.startActivity(intent);
								//  
							}
						})
				};
				var self = plus.webview.currentWebview();
				// 右滑关闭手势
				window.addEventListener('swiperight', function() {
					self.close('slide-out-right');
				})
				var nwaiting = plus.nativeUI;

				self.addEventListener('show', function() {
					// 开始扫描 
					var filter = [plus.barcode.QR, plus.barcode.EAN8, plus.barcode.EAN13, plus.barcode.CODE128,
						plus.barcode.UPCA, plus.barcode.UPCE, plus.barcode.CODABAR, plus.barcode.CODE39, plus
						.barcode.CODE93, plus.barcode.ITF, plus.barcode.PDF417
					];
					var barcodeStyle = {
						frameColor: "#1294cb",
						scanbarColor: "#1294cb"
					}
					scan = new plus.barcode.Barcode('bcid', filter, barcodeStyle);
					scan.onmarked = onmarked;
					scan.start();
					//打开关闭闪光灯处理
					var flag = false;
					document.getElementById("turnTheLight").addEventListener('tap', function() {
						if (flag == false) {
							scan.setFlash(true);
							flag = true;
						} else {
							scan.setFlash(false);
							flag = false;
						}
					});
				}, false);

				// 去设置中打开相册权限
				function openPhoto() {
					var msg = AFNUtils_langType('scan_rules_descP');
					mui.alert(msg, AFNUtils_langType('scan_rules_titleP'), AFNUtils_langType('scan_rules_btn'),
						function() {
							if (mui.os.ios) {
								plus.runtime.openURL("app-settings:PHOTO");
							} else {
								//暂未包括安卓
							}
						})
				};
				// 从相册中选择二维码图片
				document.getElementById("picBtn").addEventListener('tap', function() {
					var checkP = plus.navigator.checkPermission('GALLERY');
					if (checkP == 'denied') {
						openPhoto();
					} else {
						plus.gallery.pick(function(path) {
							plus.barcode.scan(path, onmarked, function(error) {
								plus.nativeUI.alert(AFNUtils_langType('scan_err_img'));
							});
						}, function(err) {
							// 用户取消了
							self.reload();
						});
					}
				});

				function onerror(e) {
					alert(e);
				};

				function onmarked(type, result) {
					//扫描成功之后的处理
					// scan.start();
					if (self.nameStr == 'share') {
						// 调用共享接口
						sharingUser(result);
					} else if (self.nameStr == 'bind') {
						// 回传扫描后的条码
						var pageId = plus.webview.getWebviewById('mainV/product/deviceList.html');
						mui.fire(pageId, 'getBarCode', {
							'value': result
						});
						self.close();
					} else if (self.nameStr == 'active') {
						// 回传扫描后的条码
						var pageId = plus.webview.getWebviewById('mainV/product/deviceList.html');
						mui.fire(pageId, 'getActiveCode', {
							'value': result
						});
						self.close();
					} else if (self.nameStr == 'scanMAC') {
						var pageId = plus.webview.getWebviewById('product/fb/matchWIFI.html');
						mui.fire(pageId, 'getMacCode', {
							'value': result
						});
						self.close();
					}
				};
				// 共享接口
				function sharingUser(result) {
					var token = localStorage.getItem('token');
					var user_id = localStorage.getItem('phoneNum');
					var arr = result.split('!');
					// if (result.search('!') != -1) { 
					// 	arr = result.split('!');
					// } else{//如果没找到'!'
					// 	arr = result.split(',');
					// }
					var codeinfo = arr[0];
					var time = arr[1];
					nwaiting.showWaiting(AFNUtils_langType('utils_request'));
					mui.ajax(AFNUtils.getUrlType('nomalShareP'), {
						data: {
							"user_id": user_id,
							"codeinfo": codeinfo,
							"time": time
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'post', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						headers: {
							'Content-Type': 'application/json',
							'token': token
						},
						success: function(data) {
							nwaiting.closeWaiting();
							// 分享成功
							if (data.Head.Code == 200) {
								//获得列表界面的webview
								if (AFNUtils_isCN()) {
									AFNUtils.toast(data.Head.Msg);
								} else {
									AFNUtils.toast("Share success");
								}
								var list = plus.webview.getWebviewById('mainV/product/deviceList.html');
								mui.fire(list, 'shareSuc');
								mui.back();
							} else if (data.Head.Code == 600) {
								AFNUtils.jumpLoginPage('../loginV.html');
							} else if (data.Head.Code == 700) { //token过期自动登录
								AFNUtils.updateToken();
							} else if (data.Head.Code == 800) { //其他设备登录 强制下线
								AFNUtils.jumpLoginPage('../loginV.html');
								alert(AFNUtils_langType("err_token1"));
							} else {
								scan.cancel();
								scan.start();
								if (AFNUtils_isCN()) {
									mui.alert(data.Head.Msg, '', AFNUtils_langType('other_sure'));
								} else {
									alert(AFNUtils_langType("err_title"));
								}
							}
						},
						error: function(xhr, type, errorThrown) {
							nwaiting.closeWaiting();
							mui.alert(AFNUtils_langType("err_title"), '', AFNUtils_langType('other_sure'),
								function(e) {
									scan.cancel();
									scan.start();
								});
						}
					});
				}
			});
		</script>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: #ffffff;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" class="leftIcon"></a>
			<h1 data-sw-translate class="mui-title">scan_title</h1>
			<span class="mui-icon mui-icon-spinner-cycle mui-spin mui-pull-right" id="turnTheLight"></span>
		</header>
		<div class="mui-content">
			<div id="bcid">
				<!--盛放扫描控件的div-->
			</div>

			<div class="mui-bar mui-bar-footer bottomV" style="padding: 0px;">
				<div data-sw-translate class="fbt" id="picBtn">scan_photo</div>
				<div class="fbt1"></div>
				<div data-sw-translate class="fbt mui-action-back">scan_cancel</div>
			</div>
		</div>
	</body>
</html>
